#!/usr/bin/env node

(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=require("path");var n=t.n(e);const a=require("fs");var i=t.n(a);const r=require("commander");var o=t.n(r);const l=require("cheerio");var s=t.n(l);const u=require("axios");var c=t.n(u);const m=require("crypto-js/md5");var g=t.n(m);require("fluent-ffmpeg");class d{async getChannel(t){let{data:e}=await c().get(t),n=s().load(e),a=n(".detail h1.title").text(),i="https:"+n(".detail img.img").attr("src"),r=n(".anchor-info a.nick-name").text(),o=Number(n(".pagination .quick-jump .control-input").attr("max")),l=t.match(/\/(\d+)\/?(p\d+\/?)?$/)[1];return i=i.substring(0,i.indexOf("!strip")),console.log("标题:",a),console.log("封面:",i),console.log("作者:",r),console.log("页数:",o),{albumId:l,title:a,image:i,author:r,list:[],url:t,pages:o}}async getAudioPlayUrl(t){let e=`https://www.ximalaya.com/revision/play/v1/audio?id=${t}&ptype=1`,{data:n}=await c().get(e,{headers:{"xm-sign":await this.getSign(),"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36"}});return n.data.src}async getAlbum(t){let e=await this.getChannel(t);for(let t=1;t<=e.pages;t++)e.list=e.list.concat(await this.getAudioList(e.albumId,t));return e}async getAudioList(t,e=1){console.log(`开始加载专辑 ${t} 第 ${e} 页`);let n=`https://www.ximalaya.com/revision/album/v1/getTracksList?albumId=${t}&pageNum=${e}`,{data:a}=await c().get(n,{headers:{"xm-sign":await this.getSign()}}),i=[],r=a.data.tracks;for(let t=0;t<r.length;t++)i.push({title:r[t].title,url:await this.getAudioPlayUrl(r[t].trackId),source:"https://ximalaya.com"+r[t].url,duration:r[t].duration});return i}async getSign(){let t=await c().get("https://www.ximalaya.com/revision/time").then((t=>t.data));return`{himalaya-${t}}(12)${t}(11)${Date.now()}`.replace(/{([\w-]+)}/,(function(t,e){return g()(e)}))}}const p=new(o().Command);p.option("-u, --url <url>","指定喜马拉雅专辑地址").option("-o, --output <file>","保存文件名如:rss.xml").action((async({url:t,output:e})=>{if(!t||-1===t.indexOf("www.ximalaya.com"))return console.log("请使用 -u 配置喜马拉雅地址");if(!e){let n=t.match(/\/(\d+)\/?(p\d+\/?)?$/);if(!n)return console.log("请使用 -o 配置输出文件");e=n[1]+".xml"}let a=n().dirname(n().resolve(e));var r;await(r=a,new Promise((t=>{i().exists(r,(e=>t(e)))})))||i().mkdirSync(a,{recursive:!0,mode:"755"});let o=new d,l=await o.getAlbum(t);var s,u;s=(t=>{let e=t.list.map((e=>{return`\n                <item>\n                    <title><![CDATA[${e.title}]]></title>\n                    <link><![CDATA[${e.source}]]></link>\n                    <pubDate></pubDate>\n                    <description><![CDATA[${e.title}]]></description>\n                    <itunes:image href="${t.image}"/>\n                    <enclosure url="${e.url}" type="audio/mpeg"/>\n                    <itunes:duration>${n=e.duration,`${(~~(n/3600)).toString().padStart(2,"0")}:${(~~(n/60)).toString().padStart(2,"0")}:${(~~(n%60)).toString().padStart(2,"0")}`}</itunes:duration>\n                </item>\n            `;var n}));return`\n        <rss \n            xmlns:atom="http://www.w3.org/2005/Atom"\n            xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"\n            versiion="2.0"\n            encoding="UTF-8">\n            <channel>\n                <title><![CDATA[${t.title}]]></title>\n                <link>${t.url}</link>\n                <pubDate>${new Date}</pubDate>\n                <generator>冯二毅</generator>\n                <language>zh-CN</language>\n                <itunes:author>${t.author}</itunes:author>\n                <itunes:image href="${t.image}"/>\n                <itunes:owner>\n                    <itunes:name>冯二毅</itunes:name>\n                    <itunes:email>hxtgirq710@gmail.com</itunes:email>\n                </itunes:owner>\n                ${e.join("")}\n            </channel>\n        </rss>\n        `})(l),u=e,i().writeFileSync(u,s),console.log(l.title+" RSS生成成功"),console.log("文件位于:",n().resolve(e))})),p.version("1.0.0","-v, --version","查看版本"),p.parse(process.argv)})();