#!/usr/bin/env node

(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=require("path");var n=t.n(e);const a=require("fs");var i=t.n(a);const r=require("commander");var o=t.n(r);const l=require("cheerio");var s=t.n(l);const u=require("axios");var c=t.n(u);const g=require("crypto-js/md5");var m=t.n(g);const d=require("fluent-ffmpeg");var p=t.n(d);class w{async getChannel(t){let{data:e}=await c().get(t),n=s().load(e),a=n(".detail h1.title").text(),i="https:"+n(".detail img.img").attr("src"),r=n(".anchor-info a.nick-name").text(),o=Number(n(".pagination .quick-jump .control-input").attr("max")),l=new Array(o).fill(null).map(((e,n)=>`${t}p${n+1}/`));return console.log("标题:",a),console.log("封面:",i),console.log("作者:",r),console.log("页数:",o),{title:a,image:i.substring(0,i.indexOf("!strip")),author:r,pageList:l,list:[],url:t}}async audioUrl(t){let e=`https://www.ximalaya.com/revision/play/v1/audio?id=${t}&ptype=1`,{data:n}=await c().get(e,{headers:{"xm-sign":await this.getSign(),"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36"}});return n.data.src}async audioDuration(t){return new Promise((e=>{p().ffprobe(t,((t,n)=>{if(t)return e("00:00:00");var a;e(`${(~~((a=n.format.duration)/3600)).toString().padStart(2,"0")}:${(~~(a/60)).toString().padStart(2,"0")}:${(~~(a%60)).toString().padStart(2,"0")}`)}))}))}async getAlbum(t){let e=await this.getChannel(t);return e.list=await this.getAudioList(e.pageList),e}async getAudioList(t){let e=[];for(let n=0;n<t.length;n++){console.log(`开始抓取第${n+1}页`,t[n]);let a=await this.getAudio(t[n]);e=e.concat(a)}return e}async getAudio(t){let{data:e}=await c().get(t),n=s().load(e),a=[],i=n(".detail .sound-list>ul>li");for(let t=0;t<i.length;t++){let e=n(i[t]).find(".text a"),r=n(i[t]).find(".text a").text(),o=n(i[t]).find(".text a").attr("href").split("/").pop(),l=await this.audioUrl(o);a.push({title:r,url:l,source:"https://ximalaya.com"+e.attr("href"),duration:await this.audioDuration(l)})}return a}async getSign(){let t=await this.getXMTime();return`{himalaya-${t}}(12)${t}(11)${Date.now()}`.replace(/{([\w-]+)}/,(function(t,e){return m()(e)}))}async getXMTime(){return await c().get("https://www.ximalaya.com/revision/time").then((t=>t.data))}}const h=new(o().Command);h.option("-u, --url <url>","指定喜马拉雅专辑地址").option("-o, --output <file>","保存文件名如:rss.xml").action((async({url:t,output:e})=>{if(!t||-1===t.indexOf("www.ximalaya.com"))return console.log("请使用 -u 配置喜马拉雅地址");if(!e){let n=t.match(/\/(\d+)\/?(p\d+)?$/);if(!n)return console.log("请使用 -o 配置输出文件");e=n[1]+".xml"}let a=n().dirname(n().resolve(e));var r;await(r=a,new Promise((t=>{i().exists(r,(e=>t(e)))})))||i().mkdirSync(a,{recursive:!0,mode:"755"});let o=new w,l=await o.getAlbum(t);var s,u;s=(t=>{let e=t.list.map((e=>`\n                <item>\n                    <title><![CDATA[${e.title}]]></title>\n                    <link><![CDATA[${e.source}]]></link>\n                    <pubDate></pubDate>\n                    <description><![CDATA[${e.title}]]></description>\n                    <itunes:image href="${t.image}"/>\n                    <enclosure url="${e.url}" type="audio/mpeg"/>\n                    <itunes:duration>${e.duration}</itunes:duration>\n                </item>\n            `));return`\n        <rss \n            xmlns:atom="http://www.w3.org/2005/Atom"\n            xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"\n            versiion="2.0"\n            encoding="UTF-8">\n            <channel>\n                <title><![CDATA[${t.title}]]></title>\n                <link>${t.url}</link>\n                <pubDate>${new Date}</pubDate>\n                <generator>冯二毅</generator>\n                <language>zh-CN</language>\n                <itunes:author>${t.author}</itunes:author>\n                <itunes:image href="${t.image}"/>\n                <itunes:owner>\n                    <itunes:name>冯二毅</itunes:name>\n                    <itunes:email>hxtgirq710@gmail.com</itunes:email>\n                </itunes:owner>\n                ${e.join("\r\n")}\n            </channel>\n        </rss>\n        `})(l),u=e,i().writeFileSync(u,s),console.log(l.title+" RSS生成成功"),console.log("文件位于:",n().resolve(e))})),h.version("1.0.0","-v, --version","查看版本"),h.parse(process.argv)})();