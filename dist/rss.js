#!/usr/bin/env node

(()=>{"use strict";var t={n:e=>{var a=e&&e.__esModule?()=>e.default:()=>e;return t.d(a,{a}),a},d:(e,a)=>{for(var n in a)t.o(a,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:a[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=require("path");var a=t.n(e);const n=require("fs");var i=t.n(n);const r=require("commander");var o=t.n(r);const l=require("cheerio");var s=t.n(l);const u=require("axios");var c=t.n(u);const d=require("crypto-js/md5");var p=t.n(d);class g{async getChannel(t){let{data:e}=await c().get(t),a=s().load(e),n=a(".detail h1.title").text(),i=a(".detail article.intro").text(),r="https:"+a(".detail img.img").attr("src"),o=a(".anchor-info a.nick-name").text(),l=Number(a(".pagination .quick-jump .control-input").attr("max")||1),u=t.match(/\/(\d+)\/?(p\d+\/?)?$/)[1];return r=r.substring(0,r.indexOf("!strip")),console.log("标题:",n),console.log("封面:",r),console.log("作者:",o),console.log("简介:",i),console.log("页数:",l),{albumId:u,title:n,description:i,image:r,author:o,list:[],url:t,pages:l}}async getAudioPlayUrl(t){let e=`https://www.ximalaya.com/revision/play/v1/audio?id=${t}&ptype=1`,{data:a}=await c().get(e,{headers:{"xm-sign":await this.getSign(),"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36"}});return a.data.src}async getAudioInfo(t){let e=`https://www.ximalaya.com/revision/track/simple?trackId=${t}`,{data:a}=await c().get(e),n=await this.getAudioPlayUrl(t);return{...a.data.trackInfo,playUrl:n}}async getAlbum(t){let e=await this.getChannel(t);for(let t=1;t<=e.pages;t++)e.list=e.list.concat(await this.getAudioList(e.albumId,t));return e}async getAudioList(t,e=1){console.log(`开始加载专辑 ${t} 第 ${e} 页`);let a=`https://www.ximalaya.com/revision/album/v1/getTracksList?albumId=${t}&pageNum=${e}`,{data:n}=await c().get(a,{headers:{"xm-sign":await this.getSign()}}),i=[],r=n.data.tracks;for(let t=0;t<r.length;t++){let e=await this.getAudioInfo(r[t].trackId);i.push({title:r[t].title,url:e.playUrl,source:"https://ximalaya.com"+r[t].url,duration:r[t].duration,lastUpdate:e.lastUpdate,description:e.richIntro.replace(/p><p/g,"p>\n<p").replace(/<[^>]*>/g,"").replace(/\n/g,"<br/>"),cover:"http:"+e.coverPath})}return i}async getSign(){let t=await c().get("https://www.ximalaya.com/revision/time").then((t=>t.data));return`{himalaya-${t}}(12)${t}(11)${Date.now()}`.replace(/{([\w-]+)}/,(function(t,e){return p()(e)}))}}const m=new(o().Command);m.option("-u, --url <url>","指定喜马拉雅专辑地址").option("-o, --output <file>","保存文件名如:rss.xml").action((async({url:t,output:e})=>{if(!t||-1===t.indexOf("www.ximalaya.com"))return console.log("请使用 -u 配置喜马拉雅地址");if(!e){let a=t.match(/\/(\d+)\/?(p\d+\/?)?$/);if(!a)return console.log("请使用 -o 配置输出文件");e=a[1]+".xml"}let n=a().dirname(a().resolve(e));var r;await(r=n,new Promise((t=>{i().exists(r,(e=>t(e)))})))||i().mkdirSync(n,{recursive:!0,mode:"755"});let o=new g,l=await o.getAlbum(t);var s,u;s=(t=>{let e=t.list.map((t=>{return`\n                <item>\n                    <title><![CDATA[${t.title}]]></title>\n                    <link><![CDATA[${t.source}]]></link>\n                    <pubDate>${t.lastUpdate}</pubDate>\n                    <description><![CDATA[${t.description}]]></description>\n                    <itunes:image href="${t.cover}"/>\n                    <enclosure url="${t.url}" type="audio/mpeg"/>\n                    <itunes:duration>${e=t.duration,`${(~~(e/3600)).toString().padStart(2,"0")}:${(~~(e/60)).toString().padStart(2,"0")}:${(~~(e%60)).toString().padStart(2,"0")}`}</itunes:duration>\n                </item>\n            `;var e}));return`\n        <rss \n            xmlns:atom="http://www.w3.org/2005/Atom"\n            xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"\n            version="2.0"\n            encoding="UTF-8">\n            <channel>\n                <title><![CDATA[${t.title}]]></title>\n                <link>${t.url}</link>\n                <pubDate>${new Date}</pubDate>\n                <description><![CDATA[${t.description}]]></description>\n                <generator>冯二毅</generator>\n                <language>zh-CN</language>\n                <itunes:author>${t.author}</itunes:author>\n                <itunes:image href="${t.image}"/>\n                <itunes:owner>\n                    <itunes:name>冯二毅</itunes:name>\n                    <itunes:email>hxtgirq710@gmail.com</itunes:email>\n                </itunes:owner>\n                ${e.join("")}\n            </channel>\n        </rss>\n        `})(l),u=e,i().writeFileSync(u,s),console.log(l.title+" RSS生成成功"),console.log("文件位于:",a().resolve(e))})),m.version("1.0.0","-v, --version","查看版本"),m.parse(process.argv)})();